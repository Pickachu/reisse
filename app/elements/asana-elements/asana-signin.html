<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/oauth-v2/oauth-v2.html">
<link rel="import" href="../../bower_components/rest-resource/rest-resource.html">

<dom-module id="asana-signin">
  <template>
    <oauth-v2 id="oauth"
              client_id="60637152433819"
              endpoint="https://app.asana.com/-/oauth_authorize"
              exchange_url="https://app.asana.com/-/oauth_token"
              response_type="token"
              url-params="{{params}}"
              redirect_uri="{{_redirectUri}}"
              on-response="_responded"
              on-error="_errored"></oauth-v2>
    <a href="#">{{_authStatusText}}</a>

    <iron-localstorage name="oauth-storage" value="{{auths}}"></iron-localstorage>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'asana-signin',

      properties: {
        _redirectUri: {
          type: String,
          value: function () { return document.location.origin; }
        },
        params: {
          type: Array,
          value: function () { return []; }
        },
        token: {
          type: String
        },
        authorization: {
          type: String,
          notify: true,
          computed: '_computeAuthorization(token)'
        },
        _authStatusText: {
          type: String,
          value: "Entrar com asana"
        },

        auths: {
          type: Object,
          observer: '_authsChanged'
        }
      },

      _responded (event, response) {
        this.token = response.access_token;
        this._storeAuth(response);
        this._authStatusText = "Asana Ready";
      },

      _computeAuthorization (token) {
        return `Bearer ${token}`;
      },

      // Previeous session restored
      _authsChanged (current, old) {
        // TODO use a token that expires in more than an hour
        // https://asana.com/developers/documentation/getting-started/auth
        if (current && current.asana && current.asana.access_token &&
            Date.now() < current.asana.expires_at
          ) {
          this.token = current.asana.access_token;
          this._authStatusText = "Asana Ready";
        } else {
          this.$.oauth.open();
        }
      },

      _storeAuth ({access_token, expires_in}) {
        this.auths || (this.auths = {});
        this.set('auths.asana', {access_token, expires_at: Date.now() + expires_in * 1000});
      },

      _errored() {
        debugger
      }
    });
  })();
  </script>
</dom-module>
