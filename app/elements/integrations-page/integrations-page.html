<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="integrations-page">
  <template>
    <style>
      :host { display: block; }

      :host paper-datatable, :host paper-datatable tbody { height: 50em; overflow: auto;}
      :host paper-datatable-card {
        --paper-datatable-top-toolbar: { height: auto; }
      }
    </style>
    <paper-material elevation="1">
      <content></content>
    </paper-material>

    <paper-textarea label="Columns" value="{{_columnMarkup}}"></paper-textarea>

    <paper-datatable-card header="Ocurrence library" page-size="30" data-source="[[dataSource]]" id-property="__firebaseKey__">
      <div toolbar-main style="padding: 2em;">
        <paper-dropdown-menu label="Provider">
          <paper-listbox selected="{{providerName}}" attr-for-selected="name" class="dropdown-content">
            <paper-item name="any">Any</paper-item>
            <paper-item name="asana">Asana</paper-item>
            <paper-item name="things">Things</paper-item>
            <paper-item name="i-calendar">iCalendar</paper-item>
            <paper-item name="reisse">RelissÃ«</paper-item>
            <paper-item name="jawbone">Jawbone</paper-item>
            <paper-item name="foursquare">Foursquare</paper-item>
            <paper-item name="facebook">Facebook</paper-item>
            <paper-item name="rescue-time">Rescue Time</paper-item>
            <paper-item name="youtube">YouTube</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu label="Status">
          <paper-listbox selected="{{statusName}}" attr-for-selected="name" class="dropdown-content">
            <paper-item name="any">Any</paper-item>
            <paper-item name="open">Open</paper-item>
            <paper-item name="confirmed" title="status not confirmed as an status yet on data model">Confirmed</paper-item>
            <paper-item name="completed">Completed</paper-item>
            <paper-item name="canceled">Canceled</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <paper-datatable>
        <!-- TODO figure out why sort attribute does not work
        <paper-datatable-column header="Provider Id" property="provider" type="Object" sortable align="center" sort="{{_providerSorter}}">
          <template>
						<span>[[item.provider.id]]</span>
          </template>
        </paper-datatable-column> -->
        <paper-datatable-column header="Name" type="String" sortable property="name" ></paper-datatable-column>
        <paper-datatable-column header="Features" property="features" sort="[[_featuresSorter]]">
          <template>
            <p>Duration: [[item.features.duration.actual]]</p>
          </template>
        </paper-datatable-column>
      </paper-datatable>

    </paper-datatable-card>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'integrations-page',

      properties: {
        providerName: {
          type: String,
          value: 'any'
        },
        statusName: {
          type: String,
          value: 'any'
        },
        ocurrences: Array,
        filter: {
          type: Function,
          computed: '_computeFilter(providerName, statusName)'
        },
        dataSource: {
          type: Object,
          computed: '_computeDataSource(ocurrences, filter, ocurrences.length)'
        },

        _formatDateValue: {
          type: Function,
          value() {
            return function formatDateValue (value) { return value ? moment(value).format('L LTS') : '<empty>'; };
          },
        },

        _columnMarkup: {
          type: String,
          value: "__firebaseKey__ string\nstatus string\ncompletedAt Date"
        }
      },

      observers: [
        '_computeDynamicColumns(_columnMarkup)'
      ],

      // TODO alert full ocurrence json on row tap
      // app.ocurrences.find(({__firebaseKey__}) => __firebaseKey__ === '-LKa6nhasMyXgluXCEwB');

      _computeFilter (provider, status) {
        let matcher = {};

        provider != 'any' && ( matcher.provider = {name: provider});
        status   != 'any' && ( matcher.status   = status  );

        return _.matches(matcher);
      },
      _compact (ocurrence) {
        ocurrence.providerName = ocurrence.provider.name;
        ocurrence.simplicity   = ocurrence.features.simplicity.actual;
        ocurrence.duration     = ocurrence.features.duration.actual;
      },
      _providerSorter(a, b) {
        if (!a.provider || !b.provider) return 0;
        return a.provider.id.toString().localeCompare(b.provider.id);
      },
      _featuresSorter(a, b) {
        const one   = _.get(a, 'features.duration.actual');
        const other = _.get(b, 'features.duration.actual');
        return one - other;
      },
      _computeDataSource (ocurrences, filter) {
        return {
          get(sort, page, pageSize) {
            return new Promise((resolve) => {
              // debugger
              resolve(_(ocurrences)
                .filter(filter)
                .orderBy(sort.property, sort.direction)
                .slice((page - 1) * pageSize, page * pageSize)
                .value()
              );
            });
          },
          set(item, property, value) {
            throw new Error("dataSource.set Not implemented yet.");
          }
        };
      },

      _computeDynamicColumns(markup) {
        const table = Polymer.dom(this.querySelector('paper-datatable'));

        table.querySelectorAll('.dynamic-column').forEach((column) => {
          table.removeChild(column);
        });

        const inferType = (path) => {
          if (path.includes('.')) return 'object';
          else return this.typeOf(_.get(table.node.data[0], path));
        }

        markup
          .split("\n")
          .map((column) => {

            const element = this.ownerDocument.createElement('paper-datatable-column'),
            [property, type = inferType(property)] = column.split(' '),
            formatter = '_' + _.camelCase(`format-${type}-value`);

            formatter in this && (element.formatValue = this[formatter]);

            if (type === 'object') {
              const template = this.ownerDocument.createElement('template');
              template.setAttribute('is', 'dom-bind');
              template.innerHTML = `<span>[[item.${property}]]<span>`;
              Polymer.dom(element).appendChild(template);
              element.templatize(template);
              element.template = true;
            }

            // TODO sortable support
            return Object.assign(element, {
              property, type,
              className: 'dynamic-column',
              header: _.startCase(property)
            });

          })
          .forEach((element) =>
            table.appendChild(element)
          );
      },

      typeOf(obj) {
        return ({}).toString.call(obj).match(/\s([a-zA-Z]+)/)[1].toLowerCase()
      }

    });
  })();
  </script>
</dom-module>
