<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="integrations-page">
  <template>
    <style>
      :host { display: block; }

      :host paper-datatable, :host paper-datatable tbody { height: 50em; overflow: auto;}
      :host paper-datatable-card {
        --paper-datatable-top-toolbar: { height: auto; }
      }
    </style>
    <content></content>

    <paper-datatable-card header="Ocurrence library" page-size="30" data-source="[[dataSource]]" id-property="__firebaseKey__">
      <div toolbar-main style="padding: 2em;">
        <paper-tabs selected="{{providerName}}" attr-for-selected="name">
          <paper-tab name="any">Any</paper-tab>
          <paper-tab name="asana">Asana</paper-tab>
          <paper-tab name="things">Things</paper-tab>
          <paper-tab name="i-calendar">ICalendar</paper-tab>
          <paper-tab name="reisse">RelissÃ«</paper-tab>
          <paper-tab name="jawbone">Jawbone</paper-tab>
          <paper-tab name="foursquare">Foursquare</paper-tab>
          <paper-tab name="facebook">Facebook</paper-tab>
        </paper-tabs>

        <paper-tabs selected="{{statusName}}" attr-for-selected="name">
          <paper-tab name="any">Any</paper-tab>
          <paper-tab name="open">Open</paper-tab>
          <paper-tab name="confirmed" title="status not confirmed as an status yet on data model">Confirmed</paper-tab>
          <paper-tab name="completed">Completed</paper-tab>
        </paper-tabs>
      </div>

      <paper-datatable>
        <paper-datatable-column header="ID" property="__firebaseKey__" type="String" tooltip="Some title" sortable align="center" style="min-width: 40px" sorted></paper-datatable-column>
        <paper-datatable-column header="Name" type="String" sortable property="name" ></paper-datatable-column>
        <paper-datatable-column header="Status" property="status" type="String" sortable ></paper-datatable-column>
        <paper-datatable-column header="Created At" type="Date" sortable property="createdAt"></paper-datatable-column>
        <paper-datatable-column property="simplicity" header="Simplicity"></paper-datatable-column>
      </paper-datatable>

    </paper-datatable-card>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'integrations-page',

      properties: {
        providerName: {
          type: String,
          value: 'i-calendar'
        },
        statusName: {
          type: String,
          value: 'any'
        },
        ocurrences: Array,
        filter: {
          type: Function,
          computed: '_computeFilter(providerName, statusName)'
        },
        dataSource: {
          type: Object,
          computed: '_computeDataSource(ocurrences, filter, ocurrences.length)'
        }
      },

      _computeFilter (provider, status) {
        let matcher = {};

        provider != 'any' && ( matcher.provider = {name: provider});
        status   != 'any' && ( matcher.status   = status  );

        return _.matches(matcher);
      },
      _compact (ocurrence) {
        ocurrence.providerName = ocurrence.provider.name;
        ocurrence.simplicity   = ocurrence.features.simplicity.actual;
      },
      _formatCreatedAt (value) {
        return moment(value).valueOf();
      },
      _computeDataSource (ocurrences, filter) {
        return {
          get(sort, page, pageSize) {
            return new Promise((resolve) => {
              // debugger
              resolve(_(ocurrences)
                .filter(filter)
                .orderBy(sort.property, sort.direction)
                .slice((page - 1) * pageSize, page * pageSize)
                .value()
              );
            });
          },
          set(item, property, value) {
            throw new Error("dataSource.set Not implemented yet.");
          }
        }
      }
    });
  })();
  </script>
</dom-module>
