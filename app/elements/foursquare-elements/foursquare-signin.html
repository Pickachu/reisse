<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/oauth-v2/oauth-v2.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<dom-module id="foursquare-signin">
  <style> :host { display: inline; } </style>
  <template>
    <oauth-v2 id="oauth"
      endpoint="https://foursquare.com/oauth2/authenticate"
      exchange_url="https://foursquare.com/oauth2/access_token"

      url-params="{{params}}"
      client_id="{{clientId}}"
      response_type="token"
      redirect_uri="{{_redirectUri}}"></oauth-v2>

    <a href="#">{{_authStatusText}}</a>

    <iron-localstorage name="oauth-storage" value="{{auths}}"></iron-localstorage>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'foursquare-signin',

      properties: {
        _redirectUri: {
          type: String,
          value: function () { return document.location.origin; }
        },
        clientId: {
          type: String,
          value: '10FW0GXDIRLHSSZV3S1HVL2DU1VCEL4DRBGHJMPO3BZHW0EF'
        },
        params: {
          type: Array,
          value: function () { return []; }
        },
        token: {
          type: String
        },
        authorization: {
          type: String,
          notify: true
        },
        _authStatusText: {
          type: String,
          value: "Entrar com Foursquare"
        },

        auths: {
          type: Object,
          observer: '_authsChanged'
        }
      },
      // attached () {
      //   this.async(() => {
      //     let oauth = this.$.oauth;
      //
      //     oauth.urlParams.forEach((name) => {
      //       oauth[name] || (oauth[name] = oauth.getAttribute(name));
      //     });
      //
      //
      //     // TODO open github issue to allow exchange body modification
      //     // oauth.$.exchange.method = "GET"
      //     // oauth._exchange  = this._custom_exchange.bind(oauth);
      //   });
      // },
      //
      // _custom_exchange () {
      //   if (this.response_type === 'token') {
      //     this.response = this.response_token;
      //     this.fire('response', this.response);
      //     return;
      //   }
      //   let params = JSON.parse(this._compute_exchange_body());
      //   params.grant_type = "authorization_code";
      //   params.client_secret = "b2e0ad0a8b9a2fbc6d2d85ddf3ab7641fe06f684";
      //   this.$.exchange.params = params;
      //   this.$.exchange.generateRequest();
      // },

      _responded (event, response) {
        this.authorization = response.access_token;

        this._storeAuth(response.access_token);

        this._authStatusText = "Foursquare Ready";
      },

      // Previeous session restored
      _authsChanged (current, old) {
        // TODO store token expiration date
        if (current && current.foursquare && current.foursquare.access_token) {
          this.authorization = current.foursquare.access_token;
          this._authStatusText = "Foursquare Ready";
        } else {
          this.$.oauth.open();
        }
      },

      _storeAuth (token) {
        this.auths || (this.auths = {});
        this.set('auths.foursquare', {access_token: token});
      }

    });
  })();
  </script>
</dom-module>
