<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="foursquare-venues">
  <style> :host { display: none; } </style>
  <template>
    <iron-ajax id="api" method="get" url="https://api.foursquare.com/v2/venues/search" on-response="_populate" on-error="_failed"></iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'foursquare-venues',

      properties: {
        venues: Array,

        // list of parameters: https://developer.foursquare.com/docs/venues/search
        latitude : String,
        longitude: String,
        intent: {
          type: String,
          value: 'checkin'
        },
        // TODO implement and use foursquare-signin-aware to remove this attribute
        authorization: {
          type: String
        }
      },
      observers: ['_fetch(latitude, longitude, intent, authorization)'],
      _fetch(latitude, longitude, intent, authorization) {
        if (!latitude || !longitude) return;

        this.debounce('_fetch', () => {
          let params = this._computeParams(latitude, longitude, intent, authorization),
          api = this.$.api;

          api.params = params;
          api.generateRequest();
        });
      },

      _computeParams(latitude, longitude, intent, authorization) {
        return {
          ll: `${latitude},${longitude}`,
          intent: intent,
          oauth_token: authorization,
          // TODO for other modes implement swarm-venues
          m: 'foursquare',
          v: '20160426'
        };
      },
      _populate (event, request) {
        let response = request.response,
        meta         = response.meta;

        switch (meta.code) {
          case 200:
            this.venues = response.response.venues;
            this.fire('populated');
            break;
          default:
            throw new Error(`Received invalid response code: ${meta.code}`);
        }
      },
      _failed(event, detail) {
        let request = detail.request;

        switch (request.status) {
          // Usually happens on rate limit exceded
          case 403:
            this.fire('error', detail);
            break;
          default:
            throw Error(`Received unhandled failure status code ${request.status}.`);
        }
      }
    });
  })();
  </script>
</dom-module>
