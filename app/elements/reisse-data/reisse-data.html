<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="reisse-data">
  <style>
    :host {display: none;}
  </style>
  <script>
    (function() {
      'use strict';

      Polymer.Base._addFeature({
        _notifyBoundPaths: function(path, value) {
          var a, b, method;
          method = '_notifyPath';
          if (path.indexOf('#') >= 0) {
            method = 'set';
            path = path.replace(/\.#/g, '.');
          }
          for (a in this._boundPaths) {
            b = this._boundPaths[a];
            if (path.indexOf(a + '.') === 0) {
              this[method](this._fixPath(b, a, path), value);
            } else if (path.indexOf(b + '.') === 0) {
              this[method](this._fixPath(a, b, path), value);
            }
          }
        }
      });


      Polymer({
        is: 'reisse-data',

        behaviors: [
          Polymer.FirebaseQueryBehavior
        ],

        properties: {

          /**
           * Firebase Query object corresponding to `location`.
           */
          query: {
            type: Object,
            notify: true,
            computed: '_computeQuery(location)',
            observer: '_queryChanged'
          },

          /**
           * The `data` object mapped to `location`.
           */
          data: {
            type: Object,
            notify: true
          }
        },

        listeners: {
          'firebase-value': '_onFirebaseValue'
        },

        _updatingChildren: 0,

        _localDataChanged: function(change) {
          var pathFragments = change.path.split('.');

          if (pathFragments.length === 1) {
            this._updateRemoteDocument();
            return;
          }

          // remove beginning from data binding
          pathFragments.shift();

          this._setRemoteDocumentChild(
            pathFragments,
            change.value
          );
        },

        _onFirebaseValue: function(event) {
          this._applyRemoteDataChange(function() {
            this.set('data', event.detail.val());
          });

          this.unlisten(this, 'firebase-value', '_onFirebaseValue');
        },

        _computeQuery: function(location) {
          if (!location) {
            return;
          }

          return new Firebase(location);
        },

        _updateRemoteDocument: function() {
          this._log('Updating remote document');
          this.query.update(this.dataAsObject);
        },

        _setRemoteDocumentChild: function(path, value) {
          path = this._convertPath(path);

          this.debounce('set-' + path, function() {
            this._log('Setting child "' + path + '" to', value);
            var subquery = this.query.child(path);
            subquery.once('value', this._onRemoteDocumentChildSet, this._onFailure, this);
            subquery.set(value);
          });
        },

        _onRemoteDocumentChildSet: function(snapshot) {
          this._applyRemoteDataChange(function() {
            var key = snapshot.ref().path.toString(), path;

            path = key.replace(this.query.path.toString() + '/', '').split('/');
            path.unshift('data');

            this._log('Updating local child "' + path.join('.') + '" to', snapshot.val());
            this.set(path, snapshot.val());
          });
        },

        _removeRemoteDocumentChild: function(key) {
          this._log('Removing child "' + key + '"');
          this.query.child(key).remove();
        },

        _convertPath(path) {
          return path.join('/').replace(/\#/g, '');
        },
        _onFailure (error) {
          console.log(this.is, error);
        }
      });
    })();
  </script>
</dom-module>
