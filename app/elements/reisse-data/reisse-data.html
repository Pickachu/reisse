<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="./reisse-area-source.html">

<dom-module id="reisse-data">
  <style>
    :host {display: none;}
  </style>
  <template>
    <template is="dom-repeat" items="{{sources}}" as="source">
      <reisse-area-source location="{{source.url}}" area="{{source.area}}"></reisse-area-source>
    </template>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer.Base._addFeature({
        _notifyBoundPaths: function(path, value) {
          var a, b, method;
          method = '_notifyPath';
          if (path.indexOf('#') >= 0) {
            method = 'set';
            path = path.replace(/\.#/g, '.');
          }
          for (a in this._boundPaths) {
            b = this._boundPaths[a];
            if (path.indexOf(a + '.') === 0) {
              this[method](this._fixPath(b, a, path), value);
            } else if (path.indexOf(b + '.') === 0) {
              this[method](this._fixPath(a, b, path), value);
            }
          }
        }
      });


      Polymer({
        is: 'reisse-data',

        properties: {
          base: {
            type: String,
            value: 'https://boiling-fire-6466.firebaseio.com/lore/areas',
            readOnly: true
          },
          sources: {
            type: Array,
            notify: true
          },
          areas: {
            type: Array,
            value: () => [],
            notify: true
          }
        },
        observers: [
          '_handleSplices(areas.splices)',
          '_setupSources(sources.*)'
        ],
        attached () {
          var i = 7, j = 0, sources = [];
          while (i--) {
            sources.push({
              url: this.base + "/" + j
            });
            j++;
          }

          this.sources = sources;
        },
        _setupSources (change) {
          var setuping = /^sources\.#?(\d+)\.area$/, index;
          if (!setuping.test(change.path) || !change.value || !change.value.provider) return;
          index = +setuping.exec(change.path)[1]

          this.setuping = true;
          this.linkPaths(`sources.${index}.area`, `areas.${index}`);

          // Initialize polymer collection item
          if (!this.get(['areas', index])) this.push('areas', {})

          this.set(['areas', index], change.value);
          this.notifyPath('areas', this.areas);
          this.notifyPath('areas.length', this.areas.length);

          this.setuping = false
        },
        _handleSplices (change) {
          if (!change || this.setuping) return;
          var added =  change.indexSplices.reduce((additions, splice) => {
            let object   = splice.object,
                index      = splice.index,
                addedCount = splice.addedCount;

            return additions.concat(object.slice(index, index + addedCount));
          }, []);

          added.forEach((area) => {
            let i = 0, j = this.sources.length;

            for (let i = 0, j = this.sources.length; i < j; i++) {
              var source = this.sources[i];

              if (!source.area) {
                this.set(['sources', i, 'area'], area);
                this.linkPaths(`sources.${i}.area`, `areas.${i}`);
                break;
              }
            }
          });

          change.indexSplices.forEach((splice) => {
            let removedCount = splice.removed.length, removed, property;
            while (removedCount--) {
              removed = splice.removed[removedCount];

              for (property in removed) {
                this.set(['sources', splice.index + removedCount, 'area', property], null);
              }
            }
          });
        }
      });
    })();
  </script>
</dom-module>
