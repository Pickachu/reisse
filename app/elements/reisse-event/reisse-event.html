<link rel="import" href="../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html" />
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html" />

<dom-module id="reisse-event">
  <style>
    :host {
      display: block;
      margin-bottom: 1px;
      padding-left: 0.5em;
      overflow: visible !important;
    }

    h3 {
      @apply(--title-theme);
      font-weight: normal;
      margin: 0;
    }

    paper-button {
      text-transform: none;
    }

    .emoji {
      font-family: "Apple Color Emoji","Segoe UI Emoji","NotoColorEmoji","Segoe UI Symbol","Android Emoji","EmojiSymbols";
    }

  </style>
  <template>
    <h3>
      <paper-button toggles active="{{_details}}" title="clique para ver detalhes">[[event.name]][[_optionalName]]</paper-button>
      <paper-button toggles active="{{_factors}}">Factors</paper-button>
    </h3>
    <paper-dialog opened="{{_details}}">
      <h2 title="[[__firebaseKey__]]">[[event.name]][[_optionalName]] - (details)</h2>
      <div class="layout vertical">
        <p><span>{{event.start}}</span> - <span>{{event.end}}</span></p>
        <p>Provider: <span>[[event.provider.name]]</span></p>
        <p>Area: <span>{{event.areaId}}</span></p>
        <p>Status: <span>{{event.status}} - [[event.completedAt]]</span></p>
        <p>Tags: <span class="emoji">{{event.tags}}</span></p>
        <p>Notes: <span>{{event.notes}}</span></p>
        <template is="dom-if" if="[[_computeProviderDetails(event.provider)]]" restamp="true">
          <p>Provider Details: [[_computeProviderDetails(event.provider)]]</p>
        </template>
      </div>
    </paper-dialog>

    <paper-dialog opened="{{_factors}}">
      <h2>[[event.name]][[_optionalName]] - (factors)</h2>

      <div class="layout vertical">
        <reisse-event-feature name="Chance" feature="[[event.features.chance]]" expanded >
          <reisse-event-feature name="Motivation" feature="[[event.features.motivation]]" expanded >
            <reisse-event-feature name="Sensation" feature="[[event.features.sensation]]" expanded > </reisse-event-feature>
            <reisse-event-feature name="Anticipation" feature="[[event.features.anticipation]]" expanded > </reisse-event-feature>
            <reisse-event-feature name="Belongness" feature="[[event.features.belongness]]" expanded > </reisse-event-feature>
          </reisse-event-feature>
          <reisse-event-feature name="Simplicity" feature="[[event.features.simplicity]]" expanded >
            <reisse-event-feature name="Brain Cycles" feature="[[event.features.brainCycles]]" expanded > </reisse-event-feature>
            <reisse-event-feature name="Time" feature="[[event.features.time]]" expanded > </reisse-event-feature>
            <reisse-event-feature name="Routine" feature="[[event.features.routine]]" expanded > </reisse-event-feature>
          </reisse-event-feature>
        </reisse-event-feature>

        <div class="layout horizontal around-justified">
          <p>
            <p id="duration">Duration</p>
            <paper-tooltip animation-delay="0" position="top" for="duration">
              <p>Actual: [[_formatDuration(event.features.duration.actual)]]</p>
              <p>Estimated: [[_formatDuration(event.features.duration.estimated)]]</p>
            </paper-tooltip>
          </p>
          <p>
            <p id="time-range">Start & End</p>
            <paper-tooltip animation-delay="0" position="top" for="time-range">
              <p>Actual: [[event.features.start]]</p>
              <p>Estimated: [[event.features.end]]</p>
            </paper-tooltip>
          </p>
        </div>

      </div>
    </paper-dialog>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'reisse-event',
        properties: {
          event: {
            type: Object,
            notify: true
          },
          _factors: {
            type: Boolean,
            value: false
          },
          _details: {
            type: Boolean,
            value: false
          },

          _optionalName: {
            type: String,
            computed: '_decideOptionalName(event)'
          }
        },

        observers: [
          '_computeHeight(event.features.duration.estimated)',
          '_computeOverlayMode(_factors, _details)'
        ],

        attached () {
          this.async(() => {
            let fontSize = Math.max(Math.min(this.offsetHeight - 7, 16), 7),
            lineHeight   = Math.max(Math.min(this.offsetHeight    , 18), 2);

            if (fontSize <= 12) {lineHeight = 0;}

            this.updateStyles({
              '--title-theme': `font-size: ${fontSize}px; line-height: ${lineHeight}px;`
            });
          });
        },

        _decideOptionalName (event) {
          if (event) {
            if (event.name) return '';
            else return event.provider.name;
          } else {
            return 'No event defined';
          }
        },

        // _infer (event, feature) {
        //   let estimator = Estimator.get(feature), inferal = 'inferActual' + _.upperFirst(feature);
        //   if (estimator[inferal]) {
        //     estimator[inferal](Ocurrence.fromJSON(event));
        //   } else {
        //     console.warn(this._is, 'Estimator do not implements ' + inferal + '!');
        //   }
        //   return event.features[feature].actual;
        // },

        _computeHeight (duration) {
          duration || (duration = 120);
          this.style.minHeight = Math.floor(duration / (60 * 60 * 1000)) + "em";
        },

        _computeOverlayMode(factors, details) {
          if (factors || details) {
            this.style.zIndex = 2;
          } else {
            this.style.zIndex = '';
          }

          this.toggleClass('overlayed', factors || details);
        },

        _formatDuration(duration) {
          if (duration === undefined) return;
          const formatable = moment.duration(duration);
          return `${formatable.humanize()} (${formatable})`;
        },


        _computeProviderDetails(provider) {
          if (provider === undefined) return;
          switch (provider.name) {
            case 'youtube':
              return `Video URL: https://youtube.com/watch?v=${provider.videoId}`;
            default:
              return false;
          }
        }

      });
    })();
  </script>

</dom-module>
