<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<!-- TODO <link rel="import" href="../components/reisse-feature/reisse-feature.html"> -->

<dom-module id="reisse-event">
  <style>
    :host {
      display: block;
      margin-bottom: 1px;
      padding-left: 0.5em;
      overflow: auto;
    }

    h3 {
      @apply(--title-theme);
      font-weight: normal;
      margin: 0;
    }

    paper-input {
      display: inline-block;
    }

    paper-button {
      text-transform: none;
    }

    .emoji {
      font-family: "Apple Color Emoji","Segoe UI Emoji","NotoColorEmoji","Segoe UI Symbol","Android Emoji","EmojiSymbols";
    }

  </style>
  <template>
    <h3>
      <paper-button toggles active="{{_details}}" title="clique para ver detalhes">[[event.name]][[_optionalName]]</paper-button>
      <paper-button toggles active="{{_factors}}">Factors</paper-button>
    </h3>
    <div hidden="{{_details}}" class="layout vertical">
      <p><span>{{event.start}}</span> - <span>{{event.end}}</span></p>
      <p>Status             : <span>{{event.status}} - {{event.completedAt}}</span></p>
      <p>Notes              : <span>{{event.notes}}</span></p>
      <p>Area               : <span>{{event.areaId}}</span></p>
      <p>Tags               : <span class="emoji">{{event.tagNames}}</span></p>
      <p>Provider           : <span>{{event.provider.name}}</span></p>
      <section>
        <!-- <reisse-feature key="[[event.__firebaseKey__]]" features="{{event.features}}" name="duration"></reisse-feature> -->
      </section>

      <hr />
    </div>

    <div hidden="{{_factors}}" class="layout vertical">
      <div class="layout horizontal around-justified">
        <p id="chance">Chance</p>
        <paper-tooltip animation-delay="0" position="top" for="chance">
          <p>Estimated: {{event.features.chance.estimated}}</p>
        </paper-tooltip>
      </div>

      <div class="layout horizontal around-justified">
        <p>
          <p id="motivation">Motivation</p>
          <paper-tooltip animation-delay="0" position="top" for="motivation">
            <p>Estimated: {{event.features.motivation.estimated}}</p>
          </paper-tooltip>
        </p>
        <p>
          <p id="simplicity">Simplicity</p>
          <paper-tooltip animation-delay="0" position="top" for="simplicity">
            <p>Estimated: {{event.features.simplicity.estimated}}</p>
          </paper-tooltip>
        </p>
      </div>

      <div class="layout horizontal around-justified">
        <p>
          <p id="anticipation">Anticipation</p>
          <paper-tooltip animation-delay="0" position="top" for="anticipation">
            <p>Actual: {{event.features.anticipation.actual}}</p>
            <p>Estimated: {{event.features.anticipation.estimated}}</p>
          </paper-tooltip>
        </p>
        <p>
          <p id="belongness">Belongness</p>
          <paper-tooltip animation-delay="0" position="top" for="belongness">
            <p>Actual: {{event.features.belongness.actual}}</p>
            <p>Estimated: {{event.features.belongness.estimated}}</p>
          </paper-tooltip>
        </p>
        <p>
          <p id="brainCycles">Brain cycles</p>
          <paper-tooltip animation-delay="0" position="top" for="brainCycles">
            <p>Actual   : {{event.features.brainCycles.actual}}</p>
            <p>Estimated: {{event.features.brainCycles.estimated}}</p>
            <p>Inferred : {{_infer(event, 'brainCycles')}}</p>
          </paper-tooltip>
        </p>
        <p>
          <p id="time">Time</p>
          <paper-tooltip animation-delay="0" position="top" for="time">
            <p>Estimated: {{event.features.time.estimated}}</p>
          </paper-tooltip>
        </p>
      </div>

      <div class="layout horizontal around-justified">
        <p>
          <p id="duration">Duration</p>
          <paper-tooltip animation-delay="0" position="top" for="duration">
            <p>Actual: {{event.features.duration.actual}}s</p>
            <p>Estimated: {{event.features.duration.estimated}}s</p>
          </paper-tooltip>
        </p>
      </div>

    </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'reisse-event',
        properties: {
          event: {
            type: Object,
            notify: true
          },
          _factors: {
            type: Boolean,
            value: true
          },
          _details: {
            type: Boolean,
            value: true
          },

          _optionalName: {
            type: String,
            computed: '_decideOptionalName(event)'
          }
        },

        observers: [
          '_computeHeight(event.features.duration.estimated)'
        ],

        attached () {
          this.async(() => {
            let fontSize = Math.max(Math.min(this.offsetHeight - 7, 16), 7),
            lineHeight   = Math.max(Math.min(this.offsetHeight    , 18), 2);

            if (fontSize <= 12) {lineHeight = 0;}

            this.updateStyles({
              '--title-theme': `font-size: ${fontSize}px; line-height: ${lineHeight}px;`
            });
          });
        },

        _decideOptionalName (event) {
          if (event) {
            if (event.name) return '';
            else return event.provider.name;
          } else {
            return 'No event defined';
          }
        },

        _infer (event, feature) {
          let estimator = estimators[feature](), inferal = 'inferActual' + _.upperFirst(feature);
          estimator[inferal](Ocurrence.fromJSON(event));
          return event.features[feature].actual;
        },

        _computeHeight (duration) {
          duration || (duration = 120);
          this.style.minHeight = Math.floor(duration / (60 * 60)) + "em";
        }
      });
    })();
  </script>

</dom-module>
