<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/rest-resource/rest-resource.html">

<dom-module id="resource-cursor">
  <template>
    <style> :host { display: none; } </style>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'resource-cursor',

      properties: {
        for: {
          type: Object,
          observer: '_forChanged'
        },
        paramNames: {
          type: Object,
          value: () => {
            return {
              page : 'page',
              limit: 'limit'
            };
          }
        },

        // TODO store pagination tokens
        paginationToken: {
          type: String,
          value: ''
        },

        pageSize: {
          type: Number,
          value: 100
        },

        responseTokenPath: {
          type: String,
          value: 'pagination.token'
        },

        // Currenlty request being made
        request: Object
      },

      attached () {
        this.async(() => {
          this.for = Polymer.dom(this).queryDistributedElements('rest-resource')[0];
        });
      },

      // Domain
      next (succeeded, failed, params) {
        return this.for.index(succeeded, failed, params);
      },

      hasNext() {return !!this.paginationToken; },

      values () {
        return new Promise((resolve, reject) => {
          let responded = (response) => {
            if (this.hasNext()) this.next().then(responded, reject);
            else resolve(this);
          };

          this.next().then(responded, reject);
        });
      },

      _prepareUrl(url, params, queryParams, id, action) {
        queryParams          || (queryParams = {});
        this.paginationToken && (queryParams[this.paramNames.page ] = this.paginationToken);
        queryParams[this.paramNames.limit] = this.pageSize;
        return this._oldPrepareUrl.apply(this.for, arguments);
      },

      // Integration
      _forChanged (current, old) {
        if (current && current.localName != 'rest-resource') {
          throw new TypeError(`Only 'rest-resource' can be cursored at the moment. Received '${current.localName}'`);
        }

        current && this._monitor(current);
        old     && this._unmonitor(old);
      },
      _monitor(resource) {
        this._upgradeRestResource(resource);
        this.listen(resource, 'request' , '_requested');
        this.listen(resource, 'response', '_responded');
      },

      // TODO downgrade rest resource
      _upgradeRestResource (current) {
        this._oldPrepareUrl = current._prepareUrl;
        current._prepareUrl = this._prepareUrl.bind(this);
      },

      _unmonitor(resource) {
        // this._downgradeRestResource(resource);
        this.unlisten(resource, 'request' , '_requested');
        this.unlisten(resource, 'response', '_responded');
      },

      _requested(event, detail) {
        this.request = detail.request;
      },

      _responded(event, detail) {
        let response = detail.response;
        // TODO remove lodash dependency
        this.paginationToken = _.get(response, this.responseTokenPath);
      }
    });
  })();
  </script>
</dom-module>
