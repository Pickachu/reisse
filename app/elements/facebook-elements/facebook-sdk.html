<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="facebook-sdk">
  <script>
  (function() {
    'use strict';
    let Loader = {
      schedule () {
        if (!this.scheduled) {
          this.loads = new Promise((resolve, reject) => {
            this._resolveLoads = resolve;
            this.scheduled     = true;

            if (window.FB) {return resolve(window.FB);}

            if (window.fbAsyncInit) {
              return reject(new Error('facebook-sdk: async loading already started by another script.'));
            }
            window.fbAsyncInit  = this.asyncInit.bind(this);
          });
        }
      },
      asyncInit() {
        this._resolveLoads(window.FB);
      }
    };

    Loader.schedule();

    Polymer({
      is: 'facebook-sdk',

      properties: {
        api: {type: Object, notify: true},
        appId: {type: String},
        version: {type: String, value: 'v2.7'},
        xfbml: {type: Boolean, value: true},
        _loads: {
          type: Object,
          value: Loader.loads
        },
        _configured: {
          type: Boolean,
          value: false
        }
      },

      observers: ['configure(appId, xfbml, version)'],

      configure(id, xfbml, version) {
        this.debounce('configure', () => {
          this._loads.then((api) => {
            api.init({
              appId  : id,
              xfbml  : xfbml,
              version: version
            });
            this.api = api;
          });
        });
      },

      ready () {
        (function(d, s, id){
           var js, fjs = d.getElementsByTagName(s)[0];
           if (d.getElementById(id)) {return;}
           js = d.createElement(s); js.id = id;
           js.src = "//connect.facebook.net/en_US/sdk.js";
           fjs.parentNode.insertBefore(js, fjs);
         }(document, 'script', 'facebook-jssdk'));
      }
    });
  })();
  </script>
</dom-module>
